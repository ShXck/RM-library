#include "NetworkHandler.h"

Network_Handler::Network_Handler() {
	_mode = 'n';
}

void Network_Handler::make_connection() {
	sf::IpAddress _address = sf::IpAddress::getLocalAddress();
	_socket.setBlocking( false );
	_socket.connect( _address, PORT );

	//std::thread t( &Network_Handler::run, this );
	run();
}

void Network_Handler::run() {

	std::cout << "running..." << std::endl;

	std::runtime_error not_received( "The message was not received successfully" );

	sf::Packet _packet;
	std::string _message;

	while( true ) {
		if ( _socket.receive( _packet ) == sf::Socket::Done &&  _mode == 'r' ) {
			if( _packet >> _message ) {
				_reader.read( _message );
			} else {
				throw not_received;
			}
		} else {
			throw not_received;
		}
	}
}

void Network_Handler::send( std::string message ) {
	sf::Packet _packet;
	_packet << message;
	_socket.send( _packet );
}

void Network_Handler::check_server_status() {

}

void Network_Handler::switch_mode() {
	if( _mode == 'n' ) {
		_mode = 'r';
	} else {
		_mode = 'n';
	}
}

rm::rmRef_h* Network_Handler::recent() {
	return recent_requests.last();
}

Network_Handler::~Network_Handler() {
	// TODO Auto-generated destructor stub
}

